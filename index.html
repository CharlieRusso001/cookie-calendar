<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cookie‑Powered Calendar</title>
  <style>
    :root{
      --bg: #0f172a;           /* slate-900 */
      --panel: #111827;        /* gray-900 */
      --muted: #94a3b8;        /* slate-400 */
      --text: #e5e7eb;         /* gray-200 */
      --accent: #60a5fa;       /* blue-400 */
      --accent-2: #22d3ee;     /* cyan-400 */
      --ring: rgba(96,165,250,.5);
      --card: #0b1220;         /* deep */
      --today: #1f2937;        /* gray-800 */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --shadow-hover: 0 20px 40px rgba(0,0,0,.5);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1200px 800px at 10% 10%, #0b132a 0%, var(--bg) 40%);
      display: grid; place-items: start center; padding: 24px; position: relative; overflow-x: hidden;
    }
    
    /* Shooting stars backdrop */
    .shooting-stars {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;
    }
    .star {
      position: absolute; width: 2px; height: 2px; background: rgba(96,165,250,0.8); border-radius: 50%;
      animation: shootingStar 3s linear infinite;
    }
    .star::after {
      content: ''; position: absolute; top: 0; left: 0; width: 100px; height: 1px;
      background: linear-gradient(90deg, rgba(96,165,250,0.8), transparent);
      transform: translateX(-100px);
    }
    
    @keyframes shootingStar {
      0% { transform: translateX(-100px) translateY(-100px); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateX(100vw) translateY(100vh); opacity: 0; }
    }
    .app{ width: min(1100px, 96vw); animation: fadeInUp 0.8s var(--bounce); }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: 200px 0; }
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: 16px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow); font-weight:700; color:#001018; transition: var(--transition); }
    .logo:hover { transform: rotate(10deg) scale(1.1); animation: pulse 1s infinite; }
    .title{ font-size: clamp(18px, 3vw, 24px); letter-spacing: .2px; }
    .controls{ display:flex; gap:8px; align-items:center; }
    button, input, select, textarea{ color: inherit; }
    .btn{ background:#111827; border:1px solid #1f2937; padding:10px 12px; border-radius:12px; cursor:pointer; transition: var(--transition); box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .btn:hover{ transform: translateY(-2px); border-color:#334155; box-shadow: var(--shadow-hover); }
    .btn:active{ transform: translateY(0); }
    .btn:focus-visible{ outline: 3px solid var(--ring); outline-offset: 2px; }
    .btn.ghost{ background: transparent; border-color:#1f2937; }
    .btn.ghost:hover{ background: rgba(255,255,255,0.05); }
    .btn.primary{ background: linear-gradient(135deg, #2563eb, #06b6d4); border: none; color: #03131a; font-weight: 700; }
    .btn.primary:hover{ background: linear-gradient(135deg, #1d4ed8, #0891b2); transform: translateY(-2px) scale(1.02); }
    .btn::before{ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
    .btn:hover::before{ left: 100%; }

    .calendar{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid #1f2937; border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      animation: slideIn 0.6s ease-out 0.2s both;
      position: relative;
      opacity: 1;
    }
    .calendar:hover{ box-shadow: var(--shadow-hover); }
    
    /* Month transition animations */
    .calendar.transitioning .grid { 
      pointer-events: none; 
    }
    .grid.slide-out-left { 
      animation: slideOutLeft 0.3s ease-in forwards; 
    }
    .grid.slide-out-right { 
      animation: slideOutRight 0.3s ease-in forwards; 
    }
    .grid.slide-in-left { 
      animation: slideInLeft 0.3s ease-out forwards; 
    }
    .grid.slide-in-right { 
      animation: slideInRight 0.3s ease-out forwards; 
    }
    
    @keyframes slideOutLeft {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
    }
    @keyframes slideOutRight {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    @keyframes slideInLeft {
      0% { transform: translateX(-100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideInRight {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    
    /* Zoom functionality */
    .calendar.zoom-week .grid {
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(1, 1fr);
    }
    .calendar.zoom-week .cell:not(.zoom-target) {
      display: none;
    }
    .calendar.zoom-week .cell.zoom-target {
      display: block;
      min-height: 150px;
    }
    .calendar.zoom-day {
      max-width: 500px;
      margin: 0 auto;
    }
    .calendar.zoom-day .grid {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
    }
    .calendar.zoom-day .cell:not(.zoom-target) {
      display: none;
    }
    .calendar.zoom-day .cell.zoom-target {
      display: block;
      min-height: 300px;
    }
    .calendar.zoom-day .dow {
      display: none;
    }
    
    .zoom-controls {
      display: flex; gap: 8px; margin-left: auto;
    }
    .zoom-btn {
      padding: 6px 10px; font-size: 12px;
    }
    .zoom-btn.active {
      background: var(--accent); color: #001018;
    }

    .cal-head{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; padding: 12px 12px; background: #0b1220; border-bottom: 1px solid #1f2937; }
    .cal-head .spacer{ height: 1px; }
    .month-label{ text-align:center; font-weight:700; font-size: 18px; letter-spacing: .3px; }
    .nav{ display:flex; gap:6px; justify-self:end; }

    .dow{ display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background: #1f2937; }
    .dow span{ padding:10px 6px; text-align:center; background: #0b1220; color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .12em; }

    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background: #1f2937; opacity: 1; transform: scale(1); transition: var(--transition); }
    .cell{ background: #0b1220; min-height: 110px; position:relative; transition: var(--transition); }
    .cell:hover{ background: #0f1629; transform: scale(1.02); z-index: 1; }
    .day-btn{ appearance:none; background:transparent; border:0; color:inherit; width:100%; height:100%; text-align:left; padding:10px; cursor:pointer; display:flex; flex-direction:column; gap:8px; transition: var(--transition); border-radius: 8px; }
    .day-btn:hover{ background: rgba(96,165,250,0.1); }
    .day-btn:active{ transform: scale(0.98); }
    .day-number{ font-weight:700; font-size: 14px; color: #e5e7eb; transition: var(--transition); }
    .day-btn:hover .day-number{ color: var(--accent); transform: scale(1.1); }
    .outside .day-number{ color: #475569; }
    .today{ outline: 2px dashed #334155; outline-offset:-3px; background: linear-gradient(180deg, rgba(31,41,55,.35), transparent); animation: pulse 2s infinite; }
    .today .day-number{ color: var(--accent-2); }

    .badges{ display:flex; flex-wrap:wrap; gap:5px; align-items:center; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 6px; font-size: 12px; border-radius: 999px; background:#0a0f1d; border:1px solid #1f2a44; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; transition: var(--transition); opacity: 0; animation: slideIn 0.3s ease-out forwards; }
    .badge:nth-child(1) { animation-delay: 0.1s; }
    .badge:nth-child(2) { animation-delay: 0.2s; }
    .badge:nth-child(3) { animation-delay: 0.3s; }
    .badge:hover{ transform: scale(1.05); background: rgba(96,165,250,0.1); }
    .dot{ width:8px; height:8px; border-radius:999px; display:inline-block; transition: var(--transition); }
    .badge:hover .dot{ transform: scale(1.2); }

    .layout{ display:grid; grid-template-columns: 1fr min(360px, 92vw); gap:16px; align-items:start; }
    @media (max-width: 900px){ .layout{ grid-template-columns: 1fr; } }

    .panel{ background: var(--panel); border: 1px solid #1f2937; border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); position:sticky; top:16px; transition: var(--transition); animation: slideIn 0.6s ease-out 0.4s both; }
    .panel:hover{ box-shadow: var(--shadow-hover); }
    .panel h2{ margin:4px 0 8px; font-size: 16px; letter-spacing:.2px; }
    .panel small{ color: var(--muted); }
    .empty{ color: var(--muted); padding: 10px 0 2px; }
    .list{ display:flex; flex-direction:column; gap:8px; margin: 8px 0; }
    .event{ background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px; display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; transition: var(--transition); opacity: 0; animation: slideIn 0.4s ease-out forwards; }
    .event:nth-child(1) { animation-delay: 0.1s; }
    .event:nth-child(2) { animation-delay: 0.2s; }
    .event:nth-child(3) { animation-delay: 0.3s; }
    .event:hover{ transform: translateX(5px); background: #0f1629; border-color: #334155; }
    .event-time{ color: var(--muted); font-size: 12px; }
    .event-title{ font-weight:600; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .event-actions{ display:flex; gap:6px; opacity: 0; transition: var(--transition); }
    .event:hover .event-actions{ opacity: 1; }

    .field{ display:grid; gap:6px; margin: 10px 0; }
    label{ color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing:.08em; }
    input[type="text"], input[type="time"], input[type="color"]{
      background:#0b1020; border:1px solid #1f2937; border-radius:10px; padding:9px 10px; transition: var(--transition);
    }
    input[type="text"]:focus, input[type="time"]:focus, input[type="color"]:focus{
      border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); transform: scale(1.02);
    }
    input[type="text"]:hover, input[type="time"]:hover, input[type="color"]:hover{
      border-color: #334155;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .tools{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .note{ color: var(--muted); font-size: 12px; margin-top: 8px; }
    .kbd{ font: inherit; font-size: 12px; background:#0b1020; border:1px solid #1f2937; border-radius:6px; padding:2px 6px; color:var(--text) }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Calendar application using cookies for storage">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">📅</div>
        <div class="title">Cookie‑Powered Calendar</div>
      </div>
      <div class="controls">
        <button class="btn ghost" id="todayBtn" title="Jump to Today">Today</button>
        <button class="btn ghost" id="clearBtn" title="Delete all events">Clear All</button>
        <button class="btn" id="exportBtn" title="Export events to file">Export</button>
        <label class="btn" for="importFile" title="Import events from file" style="cursor:pointer">Import <input id="importFile" type="file" accept="application/json" class="sr-only"></label>
      </div>
    </header>

    <div class="layout">
      <section class="calendar" aria-label="Interactive month calendar">
        <div class="cal-head">
          <div class="zoom-controls">
            <button class="btn ghost zoom-btn active" id="monthBtn" data-zoom="month">Month</button>
            <button class="btn ghost zoom-btn" id="weekBtn" data-zoom="week">Week</button>
            <button class="btn ghost zoom-btn" id="dayBtn" data-zoom="day">Day</button>
          </div>
          <div id="monthLabel" class="month-label" aria-live="polite"></div>
          <div class="nav" aria-label="Month navigation">
            <button class="btn ghost" id="prevBtn" aria-label="Previous month">◀</button>
            <button class="btn ghost" id="nextBtn" aria-label="Next month">▶</button>
          </div>
        </div>
        <div class="dow" aria-hidden="true">
          <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>
        <div id="grid" class="grid" role="grid" aria-label="Dates grid"></div>
      </section>

      <aside class="panel" aria-live="polite">
        <h2 id="panelDate">Select a date</h2>
        <small>Click a day to add or edit events. Data is stored in your browser cookies.</small>

        <div class="list" id="eventList"></div>
        <div id="emptyState" class="empty">No events for this day.</div>

        <form id="eventForm" autocomplete="off">
          <div class="field">
            <label for="title">Title</label>
            <input id="title" name="title" type="text" placeholder="do the thing" required maxlength="80" />
          </div>
          <div class="row">
            <div class="field">
              <label for="start">Start</label>
              <input id="start" name="start" type="time" required />
            </div>
            <div class="field">
              <label for="end">End</label>
              <input id="end" name="end" type="time" required />
            </div>
          </div>
          <div class="field">
            <label for="color">Color</label>
            <input id="color" name="color" type="color" value="#60a5fa" />
          </div>
          <div class="tools">
            <button class="btn primary" type="submit">Add Event</button>
            <button class="btn ghost" type="reset">Reset</button>
          </div>
        </form>
        <div class="note">Tip: Select a day, fill the form, and press <span class="kbd">Enter</span> to add.</div>
      </aside>
    </div>

    <p class="note" style="max-width: 65ch;">⚠️ This demo stores schedule data in cookies (client‑side only). Cookies are small (~4KB each). This app automatically splits large data across multiple cookies when needed. For shared or large calendars, consider server storage or localStorage instead.</p>
  </div>

  <script>
  // ================================
  // Cookie Utilities (with chunking)
  // ================================
  const CookieStore = (() => {
    const BASE = 'cpc_v2';             // cookie namespace
    const COUNT = BASE + '__count';     // number of chunks cookie
    const CHUNK_PREFIX = BASE + '__';
    const CHUNK_SIZE = 3500;            // keep well under 4KB to allow metadata
    const EXPIRE_DAYS = 365;            // cookie lifetime

    function getCookieRaw(name){
      const parts = document.cookie.split('; ').map(v => v.trim());
      for(const part of parts){
        if(part.startsWith(name + '=')){
          return decodeURIComponent(part.substring(name.length + 1));
        }
      }
      return null;
    }

    function setCookieRaw(name, value, days=EXPIRE_DAYS){
      const d = new Date();
      d.setTime(d.getTime() + days*24*60*60*1000);
      const expires = 'expires=' + d.toUTCString();
      const secure = location.protocol === 'https:' ? '; Secure' : '';
      document.cookie = name + '=' + encodeURIComponent(value) + '; ' + expires + '; path=/' + '; SameSite=Lax' + secure;
    }

    function deleteCookie(name){ setCookieRaw(name, '', -1); }

    function save(data){
      const json = JSON.stringify(data);
      // First clear existing chunks
      const countStr = getCookieRaw(COUNT);
      const prev = parseInt(countStr || '0', 10);
      for(let i=0;i<prev;i++) deleteCookie(CHUNK_PREFIX + i);
      deleteCookie(COUNT);

      if(json.length <= CHUNK_SIZE){
        setCookieRaw(CHUNK_PREFIX + '0', json);
        setCookieRaw(COUNT, '1');
        return;
      }
      const chunks = Math.ceil(json.length / CHUNK_SIZE);
      setCookieRaw(COUNT, String(chunks));
      for(let i=0;i<chunks;i++){
        const slice = json.slice(i*CHUNK_SIZE, (i+1)*CHUNK_SIZE);
        setCookieRaw(CHUNK_PREFIX + i, slice);
      }
    }

    function load(){
      const count = parseInt(getCookieRaw(COUNT) || '0', 10);
      // Legacy single-cookie support
      if(!count){
        const legacy = getCookieRaw('calendarData');
        if(legacy){
          try { return JSON.parse(legacy); } catch { return {}; }
        }
        return {};
      }
      let str = '';
      for(let i=0;i<count;i++){
        const part = getCookieRaw(CHUNK_PREFIX + i) || '';
        str += part;
      }
      if(!str) return {};
      try { return JSON.parse(str); } catch { return {}; }
    }

    return { save, load, deleteCookie, setCookieRaw, getCookieRaw };
  })();

  // ================================
  // Calendar/App State
  // ================================
  const state = {
    view: new Date(),    // current month being viewed
    selected: null,      // selected Date (YYYY-MM-DD)
    data: {},            // { 'YYYY-MM-DD': [ {id,title,start,end,color} ] }
  };

  // Helpers
  const pad = n => String(n).padStart(2,'0');
  const fmtDateKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseKeyToDate = (key) => { const [y,m,d] = key.split('-').map(Number); return new Date(y, m-1, d); };
  const isSameDay = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

  function uuid(){
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);
  }

  // ================================
  // Rendering the month grid
  // ================================
  const grid = document.getElementById('grid');
  const monthLabel = document.getElementById('monthLabel');
  const eventList = document.getElementById('eventList');
  const emptyState = document.getElementById('emptyState');
  const panelDate = document.getElementById('panelDate');

  function render(){
    // Only add loading state if app is already loaded and not during initial boot
    const app = document.querySelector('.app');
    const isInitialLoad = !app || !app.classList.contains('loaded');
    
    if(!isInitialLoad) {
      grid.style.opacity = '0.5';
      grid.style.transform = 'scale(0.98)';
    }
    
    const year = state.view.getFullYear();
    const month = state.view.getMonth();
    
    // Update label based on zoom level
    if(state.zoomLevel === 'month') {
      const monthName = state.view.toLocaleString(undefined,{ month:'long', year:'numeric' });
      monthLabel.textContent = monthName;
    } else if(state.zoomLevel === 'week' && state.zoomTarget) {
      const weekStart = new Date(state.zoomTarget);
      weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      if(weekStart.getMonth() === weekEnd.getMonth()) {
        monthLabel.textContent = `${weekStart.toLocaleDateString(undefined, {month: 'long', year: 'numeric'})} • Week of ${weekStart.getDate()}-${weekEnd.getDate()}`;
      } else {
        monthLabel.textContent = `Week of ${weekStart.toLocaleDateString(undefined, {month: 'short', day: 'numeric'})} - ${weekEnd.toLocaleDateString(undefined, {month: 'short', day: 'numeric', year: 'numeric'})}`;
      }
    } else if(state.zoomLevel === 'day' && state.zoomTarget) {
      monthLabel.textContent = state.zoomTarget.toLocaleDateString(undefined, {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'});
    } else {
      const monthName = state.view.toLocaleString(undefined,{ month:'long', year:'numeric' });
      monthLabel.textContent = monthName;
    }
    
    // Apply zoom level classes
    const calendar = document.querySelector('.calendar');
    calendar.className = `calendar zoom-${state.zoomLevel}`;
    if(state.isTransitioning) calendar.classList.add('transitioning');

    // Build grid days from Sunday start
    grid.innerHTML='';
    const firstOfMonth = new Date(year, month, 1);
    const startDay = firstOfMonth.getDay(); // 0..6 Sun..Sat
    const daysInMonth = new Date(year, month+1, 0).getDate();

    // Trailing days from previous month to fill the first week
    const prevMonthDays = startDay;
    const prevMonthLastDate = new Date(year, month, 0).getDate();

    const totalCells = 42; // 6 weeks grid
    const today = new Date();

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      const btn = document.createElement('button');
      btn.className = 'day-btn';
      let d;
      if(i < prevMonthDays){
        const dayNum = prevMonthLastDate - prevMonthDays + 1 + i;
        d = new Date(year, month-1, dayNum);
        cell.classList.add('outside');
      }else if(i >= prevMonthDays + daysInMonth){
        const dayNum = i - (prevMonthDays + daysInMonth) + 1;
        d = new Date(year, month+1, dayNum);
        cell.classList.add('outside');
      }else{
        const dayNum = i - prevMonthDays + 1;
        d = new Date(year, month, dayNum);
      }

      const key = fmtDateKey(d);
      btn.dataset.date = key;
      btn.setAttribute('aria-label', `Open events for ${d.toDateString()}`);

      if(isSameDay(d, today)) cell.classList.add('today');
      
      // Handle zoom targeting
      if(state.zoomLevel === 'week' && state.zoomTarget) {
        const weekStart = new Date(state.zoomTarget);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        if(d >= weekStart && d <= weekEnd) {
          cell.classList.add('zoom-target');
        }
      } else if(state.zoomLevel === 'day' && state.zoomTarget) {
        if(isSameDay(d, state.zoomTarget)) {
          cell.classList.add('zoom-target');
        }
      } else {
        // Month view - all cells are targets
        cell.classList.add('zoom-target');
      }

      const num = document.createElement('div');
      num.className = 'day-number';
      num.textContent = d.getDate();

      const badges = document.createElement('div');
      badges.className = 'badges';
      const evts = (state.data[key]||[]).slice().sort(sortByTime);
      for(const e of evts.slice(0,3)){
        const pill = document.createElement('span');
        pill.className = 'badge';
        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.style.background = e.color || 'var(--accent)';
        const txt = document.createElement('span');
        txt.textContent = `${e.title}`;
        pill.append(dot, txt);
        badges.appendChild(pill);
      }
      if(evts.length>3){
        const more = document.createElement('span');
        more.className = 'badge';
        more.textContent = `+${evts.length-3} more`;
        badges.appendChild(more);
      }

      btn.append(num, badges);
      cell.appendChild(btn);
      grid.appendChild(cell);
    }
    
    // Handle grid visibility
    if(isInitialLoad) {
      // During initial load - make grid visible immediately
      grid.style.opacity = '1';
      grid.style.transform = 'scale(1)';
    } else {
      // After app is loaded - animate grid back in
      setTimeout(() => {
        grid.style.opacity = '1';
        grid.style.transform = 'scale(1)';
      }, 50);
    }
  }

  function sortByTime(a,b){
    const A = (a.start||'00:00');
    const B = (b.start||'00:00');
    return A < B ? -1 : A > B ? 1 : 0;
  }

  // ================================
  // Day panel
  // ================================
  function openDay(key){
    state.selected = key;
    const d = parseKeyToDate(key);
    panelDate.textContent = d.toLocaleDateString(undefined, { weekday:'long', month:'long', day:'numeric', year:'numeric' });
    
    // Add visual feedback for selected day
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.remove('selected');
      if(btn.dataset.date === key) {
        btn.classList.add('selected');
        btn.style.background = 'rgba(96,165,250,0.2)';
        btn.style.transform = 'scale(1.05)';
      } else {
        btn.style.background = '';
        btn.style.transform = '';
      }
    });
    
    renderDayList();
    // Pre-fill start time to nearest hour
    const now = new Date();
    document.getElementById('start').value = pad(now.getHours()) + ':00';
    document.getElementById('end').value = pad((now.getHours()+1)%24) + ':00';
    document.getElementById('title').focus();
  }

  function renderDayList(){
    const key = state.selected;
    const items = (state.data[key]||[]).slice().sort(sortByTime);
    eventList.innerHTML = '';
    if(!items.length){ emptyState.style.display='block'; return; }
    emptyState.style.display='none';

    for(const e of items){
      const row = document.createElement('div');
      row.className = 'event';
      const color = document.createElement('span'); color.className='dot'; color.style.background = e.color || 'var(--accent)'; color.style.marginRight='4px';
      const time = document.createElement('div'); time.className='event-time'; time.textContent = e.start + '–' + e.end;
      const title = document.createElement('div'); title.className='event-title'; title.textContent = e.title;
      const actions = document.createElement('div'); actions.className='event-actions';
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete'; del.title='Delete event';
      del.addEventListener('click', () => deleteEvent(key, e.id));
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.title='Edit event';
      edit.addEventListener('click', () => editEvent(key, e.id));
      actions.append(edit, del);
      row.append(color, time, title, actions);
      eventList.appendChild(row);
    }
  }

  function editEvent(key, id){
    const items = state.data[key]||[];
    const idx = items.findIndex(x => x.id===id);
    if(idx === -1) return;
    const e = items[idx];
    document.getElementById('title').value = e.title;
    document.getElementById('start').value = e.start;
    document.getElementById('end').value = e.end;
    document.getElementById('color').value = e.color || '#60a5fa';
    // Replace on next submit
    state.__editing = { key, id };
  }

  function deleteEvent(key, id){
    const items = state.data[key]||[];
    state.data[key] = items.filter(x => x.id !== id);
    persist();
    renderDayList();
    render();
  }

  function addOrUpdateEvent(form){
    const title = form.title.value.trim();
    const start = form.start.value;
    const end = form.end.value;
    const color = form.color.value;
    if(!title) return;
    if(end <= start){
      showNotification('End time must be after start time.', 'error');
      return;
    }
    const key = state.selected || fmtDateKey(new Date());
    const list = state.data[key] || [];

    if(state.__editing){
      const idx = list.findIndex(x => x.id === state.__editing.id);
      if(idx !== -1){ list[idx] = { ...list[idx], title, start, end, color }; }
      state.__editing = null;
      showNotification('Event updated successfully!', 'success');
    }else{
      list.push({ id: uuid(), title, start, end, color });
      showNotification('Event added successfully!', 'success');
    }
    state.data[key] = list;
    persist();
    form.reset();
    renderDayList();
    render();
  }
  
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 1000;
      padding: 12px 16px; border-radius: 8px; color: white;
      font-size: 14px; font-weight: 500; max-width: 300px;
      background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#3b82f6'};
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateX(400px); opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
      notification.style.opacity = '1';
    }, 10);
    
    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function persist(){ CookieStore.save(state.data); }

  function load(){ state.data = CookieStore.load(); }

  function clearAll(){
    if(!confirm('Delete ALL events? This cannot be undone.')) return;
    state.data = {};
    persist();
    if(state.selected) renderDayList();
    render();
    showNotification('All events cleared successfully!', 'success');
  }

  // ================================
  // Export / Import
  // ================================
  function exportData(){
    const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'cookie-calendar.json'; a.click();
    URL.revokeObjectURL(url);
    showNotification('Calendar data exported successfully!', 'success');
  }

  function importData(file){
    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const obj = JSON.parse(e.target.result);
        if(!obj || typeof obj !== 'object') throw new Error('Invalid file');
        state.data = obj;
        persist();
        render();
        if(state.selected) renderDayList();
        showNotification('Calendar data imported successfully!', 'success');
      }catch(err){
        showNotification('Could not import: ' + err.message, 'error');
      }
    };
    reader.readAsText(file);
  }

  // ================================
  // Month transitions and zoom
  // ================================
  function changeMonth(direction) {
    if(state.isTransitioning) return;
    state.isTransitioning = true;
    
    const calendar = document.querySelector('.calendar');
    calendar.classList.add('transitioning');
    
    // Animate current grid out
    grid.classList.add(direction === 1 ? 'slide-out-left' : 'slide-out-right');
    
    setTimeout(() => {
      if(state.zoomLevel === 'month') {
        // Navigate months
        state.view.setMonth(state.view.getMonth() + direction);
      } else if(state.zoomLevel === 'week') {
        // Navigate weeks
        if(state.zoomTarget) {
          const newDate = new Date(state.zoomTarget);
          newDate.setDate(newDate.getDate() + (direction * 7));
          state.zoomTarget = newDate;
          
          // Update view month if we've moved to a different month
          if(newDate.getMonth() !== state.view.getMonth() || newDate.getFullYear() !== state.view.getFullYear()) {
            state.view = new Date(newDate.getFullYear(), newDate.getMonth(), 1);
          }
        }
      } else if(state.zoomLevel === 'day') {
        // Navigate days
        if(state.zoomTarget) {
          const newDate = new Date(state.zoomTarget);
          newDate.setDate(newDate.getDate() + direction);
          state.zoomTarget = newDate;
          
          // Update view month if we've moved to a different month
          if(newDate.getMonth() !== state.view.getMonth() || newDate.getFullYear() !== state.view.getFullYear()) {
            state.view = new Date(newDate.getFullYear(), newDate.getMonth(), 1);
          }
          
          // Update selected date for day view
          state.selected = fmtDateKey(newDate);
        }
      }
      
      render();
      
      // Update panel if in day view
      if(state.zoomLevel === 'day' && state.zoomTarget) {
        openDay(fmtDateKey(state.zoomTarget));
      }
      
      // Animate new grid in
      grid.classList.remove('slide-out-left', 'slide-out-right');
      grid.classList.add(direction === 1 ? 'slide-in-right' : 'slide-in-left');
      
      setTimeout(() => {
        grid.classList.remove('slide-in-left', 'slide-in-right');
        calendar.classList.remove('transitioning');
        state.isTransitioning = false;
      }, 300);
    }, 300);
  }
  
  function setZoomLevel(level, target = null) {
    state.zoomLevel = level;
    state.zoomTarget = target;
    
    // Update zoom button states
    document.querySelectorAll('.zoom-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.zoom === level);
    });
    
    render();
  }
  
  // ================================
  // Shooting stars animation
  // ================================
  function createShootingStar() {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.left = Math.random() * 100 + 'vw';
    star.style.top = Math.random() * 100 + 'vh';
    star.style.animationDelay = Math.random() * 3 + 's';
    star.style.animationDuration = (2 + Math.random() * 2) + 's';
    document.getElementById('shootingStars').appendChild(star);
    
    setTimeout(() => star.remove(), 5000);
  }
  
  function startShootingStars() {
    setInterval(createShootingStar, 800);
    // Create initial stars
    for(let i = 0; i < 3; i++) {
      setTimeout(createShootingStar, i * 300);
    }
  }
  
  // ================================
  // Boot sequence
  // ================================
  function initializeApp() {
    const bootLoader = document.getElementById('bootLoader');
    const app = document.querySelector('.app');
    
    // Start shooting stars
    startShootingStars();
    
    // Load data and initialize state first
    load();
    state.zoomLevel = 'month';
    state.zoomTarget = null;
    
    // Render calendar immediately but keep it hidden during boot
    render();
    
    setTimeout(() => {
      bootLoader.style.opacity = '0';
      setTimeout(() => {
        bootLoader.remove();
        app.classList.add('loaded');
        
        // Calendar should already be rendered, just make sure it's visible
        setTimeout(() => {
          // Ensure zoom buttons are in correct state
          document.querySelectorAll('.zoom-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.zoom === 'month');
          });
          
          // Open today's date
          openDay(fmtDateKey(new Date()));
          
          // Force visibility
          const calendar = document.querySelector('.calendar');
          calendar.style.opacity = '1';
          grid.style.opacity = '1';
          grid.style.transform = 'scale(1)';
          
        }, 100); // Minimal delay
      }, 300);
    }, 1500);
  }

  // ================================
  // Event listeners
  // ================================
  document.getElementById('prevBtn').addEventListener('click', () => changeMonth(-1));
  document.getElementById('nextBtn').addEventListener('click', () => changeMonth(1));
  document.getElementById('todayBtn').addEventListener('click', () => { state.view = new Date(); render(); openDay(fmtDateKey(new Date())); });
  document.getElementById('clearBtn').addEventListener('click', clearAll);
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importFile').addEventListener('change', (e) => { if(e.target.files[0]) importData(e.target.files[0]); e.target.value = ''; });

  grid.addEventListener('click', (e) => {
    const btn = e.target.closest('.day-btn');
    if(!btn) return;
    const clickedDate = parseKeyToDate(btn.dataset.date);
    
    // Handle zoom interactions
    if(state.zoomLevel === 'month') {
      // Double-click to zoom to week
      if(btn.dataset.lastClick && Date.now() - btn.dataset.lastClick < 300) {
        setZoomLevel('week', clickedDate);
        return;
      }
      btn.dataset.lastClick = Date.now();
    } else if(state.zoomLevel === 'week') {
      // Double-click to zoom to day
      if(btn.dataset.lastClick && Date.now() - btn.dataset.lastClick < 300) {
        setZoomLevel('day', clickedDate);
        return;
      }
      btn.dataset.lastClick = Date.now();
    }
    
    openDay(btn.dataset.date);
  });

  // Zoom controls
  document.getElementById('monthBtn').addEventListener('click', () => setZoomLevel('month'));
  document.getElementById('weekBtn').addEventListener('click', () => {
    const target = state.selected ? parseKeyToDate(state.selected) : new Date();
    setZoomLevel('week', target);
  });
  document.getElementById('dayBtn').addEventListener('click', () => {
    const target = state.selected ? parseKeyToDate(state.selected) : new Date();
    setZoomLevel('day', target);
  });

  document.getElementById('eventForm').addEventListener('submit', (e) => { e.preventDefault(); addOrUpdateEvent(e.target); });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft' && (e.metaKey || e.ctrlKey)) { changeMonth(-1); }
    if(e.key === 'ArrowRight' && (e.metaKey || e.ctrlKey)) { changeMonth(1); }
    if(e.key === 'Escape') { setZoomLevel('month'); }
  });

  // ================================
  // Init
  // ================================
  // Wait for DOM to be fully loaded
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
  </script>
</body>
</html>
